<launch>
  <arg name="audio_topic" default="audio" doc="Final output topic from mux (input for VAD/STT)" />
  <arg name="audio_info_topic" default="audio_info" />
  <arg name="device" default="" />

  <arg name="raw_audio_topic" default="audio_raw" doc="Raw audio directly from microphone" />
  <arg name="dummy_audio_topic" default="dummy_audio" doc="Topic for silence/dummy audio" />
  <arg name="trigger_topic" default="/push_to_talk"
       doc="Boolean topic to switch audio. True = Mic (Raw), False = Mute (Dummy)" />

  <node name="audio_capture" pkg="audio_capture" type="audio_capture"
        respawn="true">
    <remap from="audio" to="$(arg raw_audio_topic)" />
    <rosparam subst_value="true">
      format: wave
      channels: 1
      depth: 16
      sample_rate: 16000
      sample_format: S16LE
    </rosparam>
    <param name="device" value="$(arg device)" />
  </node>

  <node name="input_audio_mux" pkg="topic_tools" type="mux" respawn="true"
        args="$(arg audio_topic) $(arg raw_audio_topic) $(arg dummy_audio_topic)">
    <remap from="mux" to="input_audio_mux" />
  </node>

  <node name="input_audio_selector" pkg="riberry_startup" type="mux_selector.py" respawn="true" output="screen"
        args="$(arg trigger_topic) 'm.data is True' $(arg raw_audio_topic)
              $(arg trigger_topic) 'm.data is False' $(arg dummy_audio_topic)">
    <remap from="mux" to="input_audio_mux" />
    <param name="default_select" value="$(arg dummy_audio_topic)" />
    <param name="wait" value="true" />
  </node>

  <node name="keyboard_push_to_talk" pkg="riberry_startup" type="key_trigger.py"
        output="screen">
    <remap from="trigger" to="$(arg trigger_topic)" />
  </node>

  <node name="webrtcvad_ros"
        pkg="riberry_startup" type="webrtcvad_ros.py"
        output="screen" >
    <rosparam>
      aggressiveness: 1
    </rosparam>
    <remap from="audio_data" to="$(arg audio_topic)" />
    <remap from="audio_info" to="$(arg audio_info_topic)" />
  </node>

  <node name="speech_to_text_google"
        pkg="riberry_startup" type="speech_to_text.py"
        respawn="true"
        output="screen">
    <remap from="audio" to="webrtcvad_ros/speech_audio"  />
    <remap from="audio_info" to="$(arg audio_info_topic)" />
  </node>
</launch>
